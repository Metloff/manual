# HTTP

## URL

http://api.taxi.yandex.ru/v1/feature/?order_id=123&service=taxi#description

Информация из URL
- Схема взаимодействия: **http**
- Host: **api.taxi.yandex.ru**
- Path (путь до ресурса): **/v1/feature**
- Query params: **order_id=123&service=taxi**
- Fragment: **description**

## REST

URL идентифицирует ресурс - некоторую разделяемую сущность, над которой будет произведено действие. Само же действие определяется методом запроса.

## Методы запроса
- GET 
  - Получение ресурса
  - Безопасный метод
  - Идемпотентный метод
- POST
  - Действие над ресурсом
- PUT
  - Положить ресурс или полностью его заменить
  - Идемпотентный метод
- DELETE
  - Удаление ресурса
  - Идемпотентный метод
- PATCH
  - Добавлен в дополнение к PUT
  - Позваляет не полностью заменить ресурс,а обновить его часть
- HEAD
  - Безопасный метод
  - Идемпотентный метод
- CONNECT
- TRACE
  - Идемпотентный метод
- OPTIONS
  - Безопасный метод
  - Идемпотентный метод

Безопасные методы - методы, которые не вносят изменений.
Идемпотентные методы - методы, побочные эфекты от N > 0 идентичных запросов которых, идентичных эфекту от одного запроса. Другими словами, если 100 раз послать запрос с методом DELETE на `posts/2` , то мы не получим дополнительных побочных действий (удаление новых сущностей).

**POST vs PUT**

*1*

PUT используется, когда мы знаем идентификатор сущности.

`PUT /threads/messages/100500`

Если клиенту генерировать id не разрешено, ему придётся
делать POST на ресурс уровнем выше по иерархии.

`POST /threads/messages`

*2*

Если повторять POST запрос — создастся второе сообщение в треде, идентичное первому. PUT вы можете делать хоть 100500 раз, результат не изменится. Это свойство называется идемпотентностью.

В некоторых случаях нам может понажобиться, чтобы POST тоже был идемпотентный.

`{ 
    "from": "Москва, ул. Садовническая набережная 82с2",
    "to":"Аэропорт Внуково"
}`

`{
    "from": "Москва, ул. Садовническая набережная 82с2",
    "to": "Аэропорт Внуково"
    "idempotency_key": "786706b8-ed80-443a-80f6-ea1fa8cc1b51",
}`

## Запрос (Request)

Запрос содержит:
- Хедеры
- Бади

## Ответ (Response)

- Код
- Статус
- Хэдеры
- Бади

## Хэдеры

**Content-Type**

Сообщает клиенту/серверу о том, какой формат у содержимого сообщения.
Виды:
- *Content-Type*: application/json
- *Content-Type*: application/xml
- *Content-Type*: text/html; charset=utf-8
- *Content-Type*: multipart/form-data; boundary=something

**Accept**

Сообщает верверу, что работаю только с определенным форматом.

Виды:
- *Accept*: application/json
- *Accept*: application/xml

**User-Agent**

Сообщает платформу/версию клиента.

Виды:
- *User-Agent*: < product > / < product-version > < comment >
- *User-Agent*: Mozilla/< version > (system information) < platform > (< platform-details >) < extensions >


Примеры:
- *User-Agent*: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_2) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3987.116 Safari/537.36


**Authorization**

Идентификация пользователя в разных ручках. Составляется так:

*Authorization*: < тип > < данные пользователя >

Примеры типов:
- Basic (RFC 7617)
- Bearer (RFC 6750)
- и др

Примеры:
- *Authorization*: Basic QWxhZGRpbjpvcGVuIHNlc2FtZQ==
- *Authorization*: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwRydWV9.TJVA95OrM7E2cBab30RMHrHDcEfxjoYZgeFONFh7HgQ

**Accept-Language**

Сообщает серверу о текущем языке приложения. Может содержать несколько языков (локалей), но в параметре `q` выставляется предпочтение (вес).

Примеры:
- *Accept-Language*: *
- *Accept-Language*: de-CH
- *Accept-Language*: en-US,en;q=0.5
- *Accept-Language*: ru-RU, ru;q=0.9, en-US;q=0.8, en;q=0.7, fr;q=0.6 

**Retry-After**

Сообщает клиенту, через какое время можно повторить запрос. Например, если мы запустили операцию и дергаем ручку получения ее статуса, то сервер может присылать в этом хедере дату или дельту времени, когда стоит повторить запрос.

Виды:
- *Retry-After*: <http-date>
- *Retry-After*: <delay-seconds>

**Cache-Control**
Управление кешированием.

Виды:
- *Cache-Control*: must-revalidate
  - Выключение кэширования
- *Cache-Control*: no-cache
  - Выключение кэширования
- *Cache-Control*: no-store
  - Выключение кэширования
- *Cache-Control*: no-transform
- *Cache-Control*: public
  - Кэширование статического контента
- *Cache-Control*: private
- *Cache-Control*: proxy-revalidate
- *Cache-Control*: max-age=< seconds >
  - Кэширование статического контента
- *Cache-Control*: s-maxage=< seconds >
  - Кэширование статического контента

## Коды ответов

**Успешные (2хх)**
Код | Пояснение | Описание 
--- | --- | ---
200 |**OK** | Запрос успешно обработан.
201 |**Created** | Запрос успешно выполнен и в результате был создан ресурс. Этот код обычно присылается в ответ на запрос PUT "ПОМЕСТИТЬ".
202 | **Accepted** | Запрос принят, но ещё не обработан. Не поддерживаемо, т.е., нет способа с помощью HTTP отправить асинхронный ответ позже, который будет показывать итог обработки запроса. Это предназначено для случаев, когда запрос обрабатывается другим процессом или сервером, либо для пакетной обработки.
204 | **No Content** | Нет содержимого для ответа на запрос, но заголовки ответа, которые могут быть полезны, присылаются. Клиент может использовать их для обновления кешированных заголовков полученных ранее для этого ресурса.

**Перенаправление (3хх)**
Код | Пояснение | Описание 
--- | --- | ---
301 | **Moved Permanently** | Этот код ответа значит, что URI запрашиваемого ресурса был изменен. Возможно, новый URI будет предоставлен в ответе.
304 | **Not Modified** | Используется для кэширования. Это код ответа значит, что запрошенный ресурс не был изменен. Таким образом, клиент может продолжать использовать кэшированную версию ответа.

**Клиентские ошибки (4хх)**
Код | Пояснение | Описание 
--- | --- | ---
400 | **Bad Request** | Этот ответ означает, что сервер не понимает запрос из-за неверного синтаксиса (не проходит валидация или нет обязательных полей и тд).
401 | **Unauthorized** | Для получения запрашиваемого ответа нужна аутентификация. Статус похож на статус 403, но, в этом случае, аутентификация возможна. Лучше использовать 403 статус, ибо тут нужен доп хедер какой-то.
403 | **Forbidden** | У клиента нет прав доступа к содержимому, поэтому сервер отказывается дать надлежащий ответ.
404 | **Not Found** |  Сервер не может найти запрашиваемый ресурс. Код этого ответа, наверно, самый известный из-за частоты его появления в вебе.
406 | **Not Acceptable** | Этот ответ отсылается, когда веб сервер после выполнения server-driven content negotiation, не нашел контента, отвечающего критериям, полученным из user agent.
409 | **Conflict** | Этот ответ отсылается, когда запрос конфликтует с текущим состоянием сервера.
410 | **Gone** | Этот ответ отсылается, когда запрашиваемый контент удален с сервера.

**Серверные ошибки (5хх)**
Код | Пояснение | Описание 
--- | --- | ---
500 | **Internal Server Error** | Сервер столкнулся с ситуацией, которую он не знает как обработать. Обычно ее достаточно.
501 | **Not Implemented** | Метод запроса не поддерживается сервером и не может быть обработан. Единственные методы, которые сервера должны поддерживать (и, соответственно, не должны возвращать этот код) - GET и HEAD
502 | **Bad Gateway** | Эта ошибка означает что сервер, во время работы в качестве шлюза для получения ответа, нужного для обработки запроса, получил недействительный (недопустимый) ответ.
503 | **Service Unavailable** | Сервер не готов обрабатывать запрос.
504 | **Gateway Timeout** | Этот ответ об ошибке предоставляется, когда сервер действует как шлюз и не может получить ответ вовремя.


## Проектирование нового пользовательского сценария

- Описать урлы / ресурсы
- Описать методы / действия
- Описать запросы / ответы
- Описать все нестандартные случаи / ошибки
- Важно не забывать про идемпотентность (задавать себе вопрос что будет если мой новый ендпойнт будет вызван N раз с одинаковыми параметрами)


# TODO
- как идет http запрос

## Полезные ссылки:
- [видео яндекса о архитектуре](https://www.youtube.com/watch?v=dH1_g8V5vQQ&list=PLQC2_0cDcSKBHamFYA6ncnc_fYuEQUy0s&index=6)
- [презентация](https://yadi.sk/d/PivB-ZJ0UJGjYQ)
- [15 тривиальных фактов о правильной работе с протоколом HTTP
(Сергей Константинов)](https://habr.com/ru/company/yandex/blog/265569/)
- [спецификация протокола HTTP 1](https://tools.ietf.org/html/rfc2616)
- [спецификация протокола HTTP 2](https://tools.ietf.org/html/rfc5789)
- [Список HTTP кодов](https://ru.wikipedia.org/wiki/%D0%A1%D0%BF%D0%B8%D1%81%D0%BE%D0%BA_%D0%BA%D0%BE%D0%B4%D0%BE%D0%B2_%D1%81%D0%BE%D1%81%D1%82%D0%BE%D1%8F%D0%BD%D0%B8%D1%8F_HTTP)
  